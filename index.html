<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <style>
    body,html {
      margin: 0;
      padding: 0;
    }
    #chartdiv {
      width: 100%;
      height: 100vh;
      max-height: 1000px;
    }
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script type="text/javascript" src="results.js"></script>
  <script>
    const y_category = "insertion_depth"
    const x_category = "context_length"

    let data = []
    for (const [context_length, tests] of Object.entries(DATA.results)) {
      for (const test of tests) {
        data.push({
          context_length: parseInt(context_length),
          insertion_depth: parseInt(test.insertion_depth),
          value: parseInt(test.pass),
          ...test
        })
      }
    }

    am5.ready(function () {
      const root = am5.Root.new("chartdiv");
      root._logo.dispose();
      root.setThemes([
        am5themes_Animated.new(root)
      ]);
      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "none",
        wheelY: "none",
        paddingLeft: 0,
        layout: root.verticalLayout,
        title: "test"
      }));
      chart.children.unshift(am5.Label.new(root, {
        text: `Needle Test - ${DATA.model} - ${DATA.context} context - ${DATA.needle_attempts} needle attempt(s) - ${DATA.temperature !== undefined ? DATA.temperature : 1} temp - https://github.com/lucyknada/detective-needle-llm`,
        fontSize: 15,
        fontWeight: "500",
        textAlign: "center",
        x: am5.percent(50),
        centerX: am5.percent(50),
        paddingTop: 0,
        paddingBottom: 20
      }));
      const yRenderer = am5xy.AxisRendererY.new(root, {
        minGridDistance: 20,
        inversed: true,
        minorGridEnabled: true
      });
      const yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
        maxDeviation: 0,
        renderer: yRenderer,
        categoryField: y_category
      }));
      const xRenderer = am5xy.AxisRendererX.new(root, {
        minGridDistance: 20,
        grid: {
          template: {
            visible: false,
          }
        }
      });
      yRenderer.grid.template.set("visible", true);
      xRenderer.grid.template.set("visible", true);
      xRenderer.labels.template.setAll({
        rotation: -90,
        centerY: am5.p50,
        centerX: am5.p100,
        paddingRight: 15
      });
      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        renderer: xRenderer,
        categoryField: x_category
      }));
      xAxis.children.push(am5.Label.new(root, {
        text: x_category,
        textAlign: 'center',
        x: am5.p50,
        fontWeight: 'bold'
      }));
      yAxis.children.unshift(am5.Label.new(root, {
        text: y_category,
        textAlign: 'center',
        y: am5.p50,
        rotation: -90,
        fontWeight: 'bold'
      }));
      const series = chart.series.push(am5xy.ColumnSeries.new(root, {
        calculateAggregates: true,
        stroke: am5.color(0xffffff),
        clustered: false,
        xAxis: xAxis,
        yAxis: yAxis,
        categoryXField: x_category,
        categoryYField: y_category,
        valueField: "value"
      }));
      series.columns.template.setAll({
        strokeOpacity: 1,
        strokeWidth: 2,
        width: am5.percent(100),
        height: am5.percent(100)
      });
      series.set("heatRules", [{
        target: series.columns.template,
        customFunction: function(sprite, min, max, value) {
          if (sprite._dataItem.dataContext.pass > sprite._dataItem.dataContext.fail) {
            sprite.set("fill", am5.color(0x13fe82));
          } else {
            sprite.set("fill", am5.color(0xfe131a));
          }
        },
        dataField: "value",
        key: "fill"
      }]);

      series.data.setAll(data);
      yAxis.data.setAll([...new Set(data.map(y => y[y_category]))].map(y => ({[y_category]: y})).reverse());
      xAxis.data.setAll([...new Set(data.map(x => x[x_category]))].map(x => ({[x_category]: x})));
      chart.appear();
    });
  </script>
  <div id="chartdiv"></div>
</body>

</html>